name: 🚀 Deploy Consultorio Jurídico UCMC

on:
  push:
    branches: [ main ]

jobs:
  # ============================================================================
  # JOB 1: Tests y Validación
  # ============================================================================
  test:
    name: 🧪 Tests y Validación
    runs-on: ubuntu-latest
    steps:
      - name: 📥 Checkout código
        uses: actions/checkout@v4

      - name: 🐹 Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.23'

      - name: 📦 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      # Tests Backend
      - name: 🧪 Test Go Backend
        working-directory: ./go-backend
        run: |
          go mod download
          go mod verify
          go vet ./...

      # Build Frontend
      - name: 🏗️ Build React Frontend
        working-directory: ./frontend
        run: |
          npm ci
          npm run build

  # ============================================================================
  # JOB 2: Deploy to VPS
  # ============================================================================
  deploy:
    name: 🚀 Deploy to VPS
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main'

    steps:
      - name: 🚀 Deploy via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            echo "🔄 Iniciando deploy a producción..."
            cd /var/www/app_derecho

            echo "📥 Pulling latest changes..."
            git pull origin main

            echo "📋 Copiando configuración de producción..."
            if [ ! -f .env ]; then
              cp .env.production .env
            fi

            echo "🛑 Stopping containers..."
            docker-compose down

            echo "🏗️ Building containers..."
            docker-compose build --no-cache

            echo "🚀 Starting containers..."
            docker-compose up -d

            echo "⏳ Esperando servicios..."
            sleep 30

            echo "🏥 Verificando salud..."
            docker-compose ps
            
            echo "🧪 Testing API..."
            if curl -f http://localhost:8001/health; then
              echo "✅ API funcionando en puerto 8001"
            else
              echo "❌ Error en API"
              exit 1
            fi

            echo "🧹 Cleaning up..."
            docker system prune -f

            echo "✅ Deploy completado exitosamente!"
            echo "🌐 Servicio disponible en: https://servicioucmc.online"
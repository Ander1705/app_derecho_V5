name: ğŸš€ Deploy Consultorio JurÃ­dico UCMC

on:
  push:
    branches: [ main ]

jobs:
  # ============================================================================
  # JOB 1: Tests y ValidaciÃ³n
  # ============================================================================
  test:
    name: ğŸ§ª Tests y ValidaciÃ³n
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4

    - name: ğŸ¹ Setup Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.23'

    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    # Tests Backend
    - name: ğŸ§ª Test Go Backend
      working-directory: ./go-backend
      run: |
        go mod download
        go mod verify
        go vet ./...

    # Build Frontend
    - name: ğŸ—ï¸ Build React Frontend
      working-directory: ./frontend
      run: |
        npm ci
        npm run build

  # ============================================================================
  # JOB 2: Deploy
  # ============================================================================
  deploy:
    name: ğŸš€ Deploy to Production
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4

    - name: ğŸš€ Deploy via Docker Compose
      run: |
        echo "ğŸš€ Iniciando despliegue..."
        
        # Build y Deploy con Docker Compose
        docker-compose build --no-cache
        docker-compose down --remove-orphans
        docker-compose up -d
        
        # Esperar que los servicios estÃ©n listos
        echo "â³ Esperando que los servicios inicien..."
        sleep 30
        
        # Health Check
        echo "ğŸ” Verificando estado de los servicios..."
        docker-compose ps
        
        # Verificar endpoints
        curl -f http://localhost:8000/health || (echo "âŒ Backend health check failed" && exit 1)
        curl -f http://localhost:3000/health || (echo "âŒ Frontend health check failed" && exit 1)
        
        echo "âœ… Despliegue completado exitosamente!"

  # ============================================================================
  # JOB 3: NotificaciÃ³n
  # ============================================================================
  notify:
    name: ğŸ“¢ NotificaciÃ³n
    runs-on: ubuntu-latest
    needs: [test, deploy]
    if: always()

    steps:
    - name: ğŸ“¢ NotificaciÃ³n de Deploy Exitoso
      if: needs.deploy.result == 'success'
      run: |
        echo "âœ… Consultorio JurÃ­dico UCMC desplegado exitosamente en producciÃ³n!"
        echo "ğŸŒ AplicaciÃ³n disponible en: http://localhost:3000"
        echo "ğŸ”— API disponible en: http://localhost:8000"

    - name: ğŸ“¢ NotificaciÃ³n de Error
      if: failure()
      run: |
        echo "âŒ Error en el despliegue de Consultorio JurÃ­dico UCMC"
        echo "ğŸ“‹ Revisar logs de GitHub Actions para mÃ¡s detalles"
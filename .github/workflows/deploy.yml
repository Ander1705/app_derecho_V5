name: ğŸš€ Deploy Consultorio JurÃ­dico UCMC

on:
  push:
    branches: [ main ]

jobs:
  # ============================================================================
  # JOB 1: Tests y ValidaciÃ³n
  # ============================================================================
  test:
    name: ğŸ§ª Tests y ValidaciÃ³n
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ¹ Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.23'

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      # Tests Backend
      - name: ğŸ§ª Test Go Backend
        working-directory: ./go-backend
        run: |
          go mod download
          go mod verify
          go vet ./...

      # Build Frontend
      - name: ğŸ—ï¸ Build React Frontend
        working-directory: ./frontend
        run: |
          npm ci
          npm run build

  # ============================================================================
  # JOB 2: Deploy to VPS
  # ============================================================================
  deploy:
    name: ğŸš€ Deploy to VPS
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main'

    steps:
      - name: ğŸš€ Deploy via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            echo "ğŸ”„ Iniciando deploy a producciÃ³n..."
            cd /var/www/app_derecho

            echo "ğŸ“¥ Pulling latest changes..."
            git pull origin main

            echo "ğŸ“‹ Copiando configuraciÃ³n de producciÃ³n..."
            if [ ! -f .env ]; then
              cp .env.production .env
            fi

            echo "ğŸ›‘ Stopping containers..."
            docker-compose down

            echo "ğŸ—ï¸ Building containers..."
            docker-compose build --no-cache

            echo "ğŸš€ Starting containers..."
            docker-compose up -d

            echo "â³ Esperando servicios..."
            sleep 30

            echo "ğŸ¥ Verificando salud..."
            docker-compose ps
            
            echo "ğŸ§ª Testing API..."
            if curl -f http://localhost:8001/health; then
              echo "âœ… API funcionando en puerto 8001"
            else
              echo "âŒ Error en API"
              exit 1
            fi

            echo "ğŸ§¹ Cleaning up..."
            docker system prune -f

            echo "âœ… Deploy completado exitosamente!"
            echo "ğŸŒ Servicio disponible en: https://servicioucmc.online"